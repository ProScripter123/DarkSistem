name: üèóÔ∏è Build Dark System APK - Fixed

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  repository_dispatch:

env:
  APP_ID: "com.darksystem.app"
  APP_NAME: "DarkSystem"
  APP_VERSION: "3.0.0"

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì¶ Checkout Repository
      uses: actions/checkout@v4
    
    - name: üõ†Ô∏è Quick Setup (Skip problematic SDK)
      run: |
        echo "üöÄ Quick setup for Dark System APK build..."
        
        # Install minimal dependencies
        sudo apt-get update
        sudo apt-get install -y \
          nodejs \
          npm \
          openjdk-17-jdk \
          wget \
          unzip \
          zip
        
        # Install Cordova
        sudo npm install -g cordova@11.0.0  # Use stable version
        
        # Create minimal Android SDK structure
        mkdir -p ~/android-sdk
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        
        echo "‚úÖ Quick setup complete"
    
    - name: ‚òï Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: ‚ö° Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: üì± Install Android SDK Minimal
      run: |
        echo "üì± Installing minimal Android SDK..."
        
        # Create directories
        mkdir -p $ANDROID_HOME
        
        # Download OLDER but stable command line tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip -O cmdline-tools.zip
        
        # Extract
        unzip -q cmdline-tools.zip -d $ANDROID_HOME/
        mv $ANDROID_HOME/cmdline-tools $ANDROID_HOME/cmdline-tools-latest
        rm cmdline-tools.zip
        
        # Add to PATH
        echo "$ANDROID_HOME/cmdline-tools-latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
        
        echo "‚úÖ Android SDK tools installed"
    
    - name: üìã Install ONLY Essential SDK Components
      run: |
        echo "üìã Installing essential SDK components..."
        
        # Set to skip JDK check
        export SKIP_JDK_VERSION_CHECK=1
        
        # Accept licenses (non-interactive)
        yes | $ANDROID_HOME/cmdline-tools-latest/bin/sdkmanager --licenses 2>/dev/null || true
        
        # Install ONLY the essential packages (avoid problematic ones)
        echo "Installing platform-tools..."
        $ANDROID_HOME/cmdline-tools-latest/bin/sdkmanager "platform-tools" 2>&1 | tail -20
        
        echo "Installing platform android-33..."
        $ANDROID_HOME/cmdline-tools-latest/bin/sdkmanager "platforms;android-33" 2>&1 | tail -20
        
        echo "Installing build-tools 30.0.3 (more stable)..."
        $ANDROID_HOME/cmdline-tools-latest/bin/sdkmanager "build-tools;30.0.3" 2>&1 | tail -20
        
        echo "‚úÖ Essential components installed"
    
    - name: üîç Verify Installation
      run: |
        echo "üîç Verification:"
        echo "Java: $(java -version 2>&1 | head -1)"
        echo "Node: $(node --version)"
        echo "Cordova: $(cordova --version 2>/dev/null || echo 'Not found')"
        echo "Android SDK: $ANDROID_HOME"
        
        # List installed packages
        if [ -f "$ANDROID_HOME/cmdline-tools-latest/bin/sdkmanager" ]; then
          echo "Installed packages:"
          $ANDROID_HOME/cmdline-tools-latest/bin/sdkmanager --list 2>/dev/null | grep "installed" || true
        fi
    
    - name: üèóÔ∏è Create Cordova Project Structure
      run: |
        echo "üèóÔ∏è Creating project structure..."
        
        # Create project
        cordova create dark-app $APP_ID "$APP_NAME"
        cd dark-app
        
        # Add Android platform
        cordova platform add android@11.0.0  # Use older stable version
        
        # Remove default content
        rm -rf www/*
        
        echo "‚úÖ Project structure created"
    
    - name: üìÇ Copy Dark System Files
      run: |
        cd dark-app
        
        echo "üìÇ Copying files..."
        
        # Check if source files exist
        if [ -d "../www" ]; then
          # Copy existing www directory
          cp -r ../www/* www/
          echo "‚úÖ Copied existing www directory"
        else
          # Create minimal Dark System interface
          mkdir -p www
          
          # Create index.html
          cat > www/index.html << 'HTML'
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Dark System v3.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
        }
        .container { max-width: 100%; }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { font-size: 2em; margin-bottom: 10px; color: #00ff00; }
        .login-box {
            background: #111;
            padding: 20px;
            border: 2px solid #00ff00;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        input, button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #222;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: 'Courier New';
            font-size: 16px;
        }
        button {
            background: #00ff00;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }
        .features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .feature {
            background: #111;
            padding: 15px;
            border: 1px solid #333;
            text-align: center;
        }
        .build-info {
            text-align: center;
            margin-top: 30px;
            color: #888;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">‚ö° DARK SYSTEM v3.0</div>
            <p>Built via GitHub Actions</p>
        </div>
        
        <div class="login-box">
            <h3>üîê ACCESS CONTROL</h3>
            <input type="text" id="username" value="IENZ" readonly>
            <input type="password" id="password" value="1122" readonly>
            <button onclick="login()">‚ñ∂Ô∏è LAUNCH SYSTEM</button>
        </div>
        
        <div class="features">
            <div class="feature">‚ö° DDoS Tools</div>
            <div class="feature">üîç OSINT</div>
            <div class="feature">üì± Bug WA</div>
            <div class="feature">üåê Network Scan</div>
        </div>
        
        <div class="build-info">
            <p>Repository: ProScripter123/DarkSistem</p>
            <p id="build-date">Build: Loading...</p>
        </div>
    </div>
    
    <script>
        document.getElementById('build-date').textContent = 'Build: ' + new Date().toLocaleString();
        
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'IENZ' && password === '1122') {
                alert('‚úÖ ACCESS GRANTED\n\nDark System initialized.\n\nFeatures:\n‚Ä¢ DDoS Attack Panel\n‚Ä¢ OSINT Gathering\n‚Ä¢ WhatsApp Exploits\n‚Ä¢ Network Scanner');
                
                // Show system interface
                document.body.innerHTML = `
                    <div style="padding: 20px;">
                        <h1>‚ö° DARK SYSTEM ACTIVE</h1>
                        <p>All systems operational.</p>
                        <button onclick="location.reload()">Logout</button>
                    </div>
                `;
            } else {
                alert('‚ùå ACCESS DENIED');
            }
        }
        
        // Auto-login after 3 seconds
        setTimeout(() => {
            document.getElementById('username').value = 'IENZ';
            document.getElementById('password').value = '1122';
        }, 1000);
    </script>
</body>
</html>
HTML
          
          echo "‚úÖ Created Dark System interface"
        fi
        
        # Ensure icon exists
        mkdir -p www/res/icon/android
        if [ ! -f "www/res/icon/android/icon.png" ]; then
          # Create simple icon using base64 (if convert not available)
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" | base64 -d > www/res/icon/android/icon.png 2>/dev/null || \
          echo "ICON" > www/res/icon/android/icon.png
          echo "‚úÖ Created placeholder icon"
        fi
    
    - name: ‚öôÔ∏è Create Minimal config.xml
      run: |
        cd dark-app
        
        cat > config.xml << XML
<?xml version='1.0' encoding='utf-8'?>
<widget id="$APP_ID" version="$APP_VERSION" xmlns="http://www.w3.org/ns/widgets">
    <name>$APP_NAME</name>
    <description>Dark System - Security Toolkit</description>
    <author>GitHub: ProScripter123/DarkSistem</author>
    <content src="index.html" />
    <access origin="*" />
    <allow-intent href="*" />
    
    <preference name="android-minSdkVersion" value="21" />
    <preference name="android-targetSdkVersion" value="30" />
    <preference name="Orientation" value="portrait" />
    
    <platform name="android">
        <icon src="www/res/icon/android/icon.png" />
    </platform>
</widget>
XML
        
        echo "‚úÖ config.xml created"
    
    - name: üîå Add Only Essential Plugin
      run: |
        cd dark-app
        
        # Add only whitelist plugin (essential)
        cordova plugin add cordova-plugin-whitelist
        
        echo "‚úÖ Plugin added"
    
    - name: üõ†Ô∏è Build APK (Simplified)
      run: |
        cd dark-app
        
        echo "üõ†Ô∏è Building APK..."
        
        # Clean and prepare
        cordova prepare android
        
        # Build with minimal flags
        cordova build android --debug 2>&1 | tail -50
        
        # Check result
        if [ -f "platforms/android/app/build/outputs/apk/debug/app-debug.apk" ]; then
          APK_SIZE=$(du -h platforms/android/app/build/outputs/apk/debug/app-debug.apk | cut -f1)
          echo "‚úÖ SUCCESS: APK built! Size: $APK_SIZE"
        else
          echo "‚ö†Ô∏è APK not found in expected location"
          echo "Searching for APK files..."
          find platforms/android -name "*.apk" 2>/dev/null || echo "No APK files found"
        fi
    
    - name: üìä Find and List APKs
      run: |
        echo "üìä Searching for APK files..."
        
        if [ -d "dark-app/platforms/android" ]; then
          cd dark-app
          find platforms/android -name "*.apk" -type f | while read file; do
            echo "‚Ä¢ $file ($(du -h "$file" | cut -f1))"
          done || echo "No APK files found"
        else
          echo "‚ùå No Android platform directory"
        fi
    
    - name: ‚¨ÜÔ∏è Upload ANY Found APK
      uses: actions/upload-artifact@v4
      with:
        name: DarkSystem-Output
        path: |
          dark-app/platforms/android/app/build/outputs/apk/**/*.apk
          dark-app/platforms/android/*.apk
          dark-app/*.apk
        if-no-files-found: warn
        retention-days: 7
    
    - name: üì¶ Create Fallback Download
      if: failure()
      run: |
        echo "üì¶ Creating fallback package..."
        
        # Create a simple HTML version as fallback
        mkdir -p fallback
        cat > fallback/index.html << 'HTML'
<!DOCTYPE html>
<html>
<head>
    <title>Dark System - Fallback</title>
    <style>
        body { background: #000; color: #0f0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .download { background: #0f0; color: #000; padding: 15px; margin: 10px; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö†Ô∏è APK Build Failed</h1>
        <p>Dark System APK build encountered issues.</p>
        <p>Alternative solutions:</p>
        <ol>
            <li>Build locally with: <code>cordova build android</code></li>
            <li>Use Termux on Android to build</li>
            <li>Try PhoneGap Build online</li>
        </ol>
        <p>Login: IENZ / 1122</p>
    </div>
</body>
</html>
HTML
        
        zip -r fallback-darksystem.zip fallback/
        
        echo "‚úÖ Fallback package created"
    
    - name: ‚¨ÜÔ∏è Upload Fallback Package
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: DarkSystem-Fallback
        path: fallback-darksystem.zip
    
    - name: üìù Create Result Summary
      if: always()
      run: |
        echo "## üèóÔ∏è Dark System Build Result" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "dark-app/platforms/android/app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "### ‚úÖ BUILD SUCCESSFUL!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**APK generated successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download from:** Artifacts ‚Üí DarkSystem-Output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Installation:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download APK" >> $GITHUB_STEP_SUMMARY
          echo "2. Enable 'Unknown Sources' on Android" >> $GITHUB_STEP_SUMMARY
          echo "3. Install APK" >> $GITHUB_STEP_SUMMARY
          echo "4. Login: **IENZ / 1122**" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ö†Ô∏è BUILD ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "APK build encountered issues. Check logs above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Alternative solutions:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Build locally on your machine" >> $GITHUB_STEP_SUMMARY
          echo "2. Use Termux on Android device" >> $GITHUB_STEP_SUMMARY
          echo "3. Try online build services" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Login credentials always:** IENZ / 1122" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Repository: [ProScripter123/DarkSistem](https://github.com/ProScripter123/DarkSistem)*" >> $GITHUB_STEP_SUMMARY
