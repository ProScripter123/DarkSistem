name: Build HTML to APK (Cordova Debug)

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Cordova
        run: npm install -g cordova@11.0.0

      - name: Install project dependencies
        run: npm install

      - name: Check Cordova setup
        run: |
          echo "=== Cordova Version ==="
          cordova --version
          echo "=== Current directory ==="
          pwd
          echo "=== Listing files ==="
          ls -la

      - name: Add Android platform (with force if needed)
        run: |
          # Remove if exists
          rm -rf platforms android platforms/android 2>/dev/null || true
          rm -rf plugins 2>/dev/null || true
          
          # Create necessary directories
          mkdir -p platforms
          mkdir -p plugins
          
          # Add android platform
          cordova platform add android@10.1.2 --verbose || cordova platform add android --verbose
          
          echo "=== After adding platform ==="
          ls -la platforms/
          if [ -d "platforms/android" ]; then
            echo "Android platform directory exists"
            ls -la platforms/android/
          else
            echo "ERROR: Android platform directory NOT created!"
          fi

      - name: Verify Android platform structure
        run: |
          if [ -d "platforms/android" ]; then
            echo "=== Android platform structure ==="
            find platforms/android -type f -name "gradlew" -o -name "*.gradle" -o -name "build.gradle" | head -20
            echo "=== gradlew file check ==="
            if [ -f "platforms/android/gradlew" ]; then
              echo "gradlew exists"
              ls -la platforms/android/gradlew
            else
              echo "gradlew NOT found, checking alternatives..."
              find platforms/android -name "gradlew" -type f
            fi
          else
            echo "ERROR: platforms/android directory does not exist!"
            exit 1
          fi

      - name: Prepare Android project
        run: |
          cordova prepare android --verbose
          
          # If gradlew still doesn't exist, create it
          if [ ! -f "platforms/android/gradlew" ]; then
            echo "Creating gradlew manually..."
            cd platforms/android
            gradle wrapper --gradle-version=7.5.1
            chmod +x gradlew
            cd ../..
          else
            cd platforms/android
            chmod +x gradlew
            cd ../..
          fi

      - name: Check Android requirements
        run: |
          cordova requirements android --verbose

      - name: Build Android APK
        run: |
          echo "=== Starting build ==="
          cordova build android --debug --verbose 2>&1 | tee build.log || {
            echo "Build failed!"
            echo "=== Last 100 lines of build log ==="
            tail -100 build.log
            exit 1
          }

      - name: Find APK files
        run: |
          echo "=== Searching for APK files ==="
          find . -name "*.apk" -type f 2>/dev/null | xargs -I {} echo "Found: {}"
          
          if [ -d "platforms/android/app/build/outputs/apk" ]; then
            echo "=== Standard APK location ==="
            find platforms/android/app/build/outputs/apk -name "*.apk" -type f
          fi
          
          if [ -d "platforms/android/build/outputs/apk" ]; then
            echo "=== Alternative APK location ==="
            find platforms/android/build/outputs/apk -name "*.apk" -type f
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: |
            platforms/android/app/build/outputs/apk/**/*.apk
            platforms/android/build/outputs/apk/**/*.apk
          if-no-files-found: warn

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build.log
