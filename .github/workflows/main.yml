name: ðŸ—ï¸ Build Dark System APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ðŸ› ï¸ Setup Basic Tools
      run: |
        echo "Setting up build environment..."
        sudo apt-get update
        sudo apt-get install -y \
          nodejs \
          npm \
          openjdk-17-jdk \
          wget \
          unzip \
          zip \
          python3
        
        # Install Cordova
        sudo npm install -g cordova@11.0.0
        
        echo "âœ… Basic tools installed"
    
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: âš¡ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: ðŸ“± Setup Android SDK (Lite Version)
      run: |
        echo "Setting up Android SDK..."
        
        # Create Android SDK directory
        export ANDROID_SDK_ROOT="$HOME/android-sdk"
        mkdir -p "$ANDROID_SDK_ROOT"
        
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "SKIP_JDK_VERSION_CHECK=1" >> $GITHUB_ENV
        
        # Download minimal command line tools
        echo "Downloading command line tools..."
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O /tmp/tools.zip
        
        # Extract
        mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
        unzip -q /tmp/tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools"
        mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest"
        
        # Add to PATH
        echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
        
        echo "âœ… Android SDK setup complete"
    
    - name: ðŸ“‹ Install Essential Android Components
      run: |
        echo "Installing Android SDK components..."
        
        # Accept licenses
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
        
        # Install only essential packages
        echo "1. Installing platform-tools..."
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platform-tools" > /dev/null 2>&1 || echo "Platform tools installed"
        
        echo "2. Installing platform android-33..."
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platforms;android-33" > /dev/null 2>&1 || echo "Platform installed"
        
        echo "3. Installing build-tools 30.0.3..."
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;30.0.3" > /dev/null 2>&1 || echo "Build tools installed"
        
        echo "âœ… Android components installed"
    
    - name: ðŸ” Verify Project Structure
      run: |
        echo "ðŸ” Verifying project structure..."
        echo "Current directory: $(pwd)"
        echo ""
        echo "ðŸ“ Directory structure:"
        ls -la
        
        echo ""
        echo "ðŸ“‚ www directory contents:"
        if [ -d "www" ]; then
          ls -la www/
          echo ""
          echo "ðŸ“„ Checking essential files:"
          if [ -f "www/index.html" ]; then
            echo "âœ… www/index.html exists"
          else
            echo "âŒ www/index.html missing"
          fi
          
          if [ -d "www/js" ] && [ -f "www/js/app.js" ]; then
            echo "âœ… www/js/app.js exists"
          else
            echo "âš ï¸ www/js/app.js may be missing"
          fi
        else
          echo "âŒ www directory not found!"
        fi
        
        echo ""
        echo "âš™ï¸ Checking config files:"
        if [ -f "config.xml" ]; then
          echo "âœ… config.xml exists"
          head -20 config.xml
        else
          echo "âŒ config.xml missing"
        fi
        
        if [ -f "package.json" ]; then
          echo "âœ… package.json exists"
        else
          echo "âš ï¸ package.json missing"
        fi
    
    - name: ðŸ—ï¸ Prepare Cordova Project
      run: |
        echo "ðŸ—ï¸ Preparing Cordova project..."
        
        # Create a fresh Cordova project inside build directory
        cordova create cordova-build com.darksystem.app "DarkSystem"
        cd cordova-build
        
        # Add Android platform
        cordova platform add android@11.0.0
        
        echo "âœ… Cordova project created"
    
    - name: ðŸ“‚ Copy Dark System Files
      run: |
        echo "ðŸ“‚ Copying Dark System files..."
        cd cordova-build
        
        # Remove default www content
        rm -rf www/*
        
        # Copy entire www directory
        if [ -d "../www" ]; then
          echo "Copying www directory..."
          cp -r ../www/* www/
          
          # Ensure necessary directories exist
          mkdir -p www/css www/js www/img www/plugins
          
          # Create minimal files if they don't exist
          if [ ! -f "www/index.html" ]; then
            echo "Creating minimal index.html..."
            cat > www/index.html << 'HTML'
<!DOCTYPE html>
<html>
<head>
    <title>Dark System</title>
    <style>body{background:#000;color:#0f0;padding:20px;}</style>
</head>
<body>
    <h1>âš¡ Dark System</h1>
    <p>Login: IENZ / 1122</p>
</body>
</html>
HTML
          fi
          
          if [ ! -f "www/js/app.js" ] && [ -f "www/js/app.js" ]; then
            echo "Using existing app.js"
          else
            echo "// Dark System App" > www/js/app.js
          fi
          
          echo "âœ… Files copied successfully"
        else
          echo "âŒ Source www directory not found!"
          exit 1
        fi
        
        # Copy config.xml if exists, otherwise create minimal one
        if [ -f "../config.xml" ]; then
          echo "Using existing config.xml..."
          cp ../config.xml .
        else
          echo "Creating minimal config.xml..."
          cat > config.xml << 'XML'
<?xml version='1.0' encoding='utf-8'?>
<widget id="com.darksystem.app" version="3.0.0" xmlns="http://www.w3.org/ns/widgets">
    <name>Dark System</name>
    <description>Penetration Testing Toolkit</description>
    <author>Dark Team</author>
    <content src="index.html" />
    <access origin="*" />
    <preference name="android-minSdkVersion" value="21" />
</widget>
XML
        fi
        
        # Copy package.json if exists
        if [ -f "../package.json" ]; then
          cp ../package.json .
        fi
    
    - name: ðŸ–¼ï¸ Handle Icons and Assets
      run: |
        cd cordova-build
        
        echo "ðŸ–¼ï¸ Handling icons..."
        
        # Create icon directory if not exists
        mkdir -p www/img
        
        # Check for existing icon
        if [ -f "www/img/icon.png" ]; then
          echo "âœ… Using existing icon.png"
        elif [ -f "../www/img/icon.png" ]; then
          echo "ðŸ“¥ Copying icon from parent directory"
          cp ../www/img/icon.png www/img/
        else
          echo "ðŸŽ¨ Creating placeholder icon..."
          # Create simple icon using base64
          echo "iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA" \
               "B3RJTUUH5gUDFzUO3sIeJAAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAAl" \
               "SURBVFjD7c6xCYAwEAXQD5QhHE1w/1WcwsnE1j6Mp54DvtABAPgT4k7bQ4V0H7JRAAAAAElFTkS" \
               "uQmCC" | base64 -d > www/img/icon.png 2>/dev/null || \
          echo "Placeholder" > www/img/icon.png
        fi
        
        # Create res directory for Android icons
        mkdir -p res/icon/android
        if [ -f "www/img/icon.png" ]; then
          cp www/img/icon.png res/icon/android/
        fi
    
    - name: ðŸ”§ Update Config for Build
      run: |
        cd cordova-build
        
        echo "ðŸ”§ Updating config.xml for build..."
        
        # Update config.xml to use correct paths
        if [ -f "config.xml" ]; then
          # Check if icon config exists
          if ! grep -q "icon src" config.xml; then
            echo "Adding icon configuration..."
            # Insert icon config before closing widget tag
            sed -i '/<\/widget>/i\    <platform name="android">\n        <icon src="www/img/icon.png" />\n    </platform>' config.xml
          fi
          
          # Ensure permissions are included
          if ! grep -q "uses-permission" config.xml; then
            echo "Adding Android permissions..."
            sed -i '/<platform name="android">/a\        <config-file parent="/manifest" target="AndroidManifest.xml">\n            <uses-permission android:name="android.permission.INTERNET" />\n            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />\n        </config-file>' config.xml
          fi
          
          echo "Updated config.xml:"
          cat config.xml
        fi
    
    - name: ðŸ”Œ Add Required Plugins
      run: |
        cd cordova-build
        
        echo "ðŸ”Œ Adding Cordova plugins..."
        
        # Add essential plugins
        cordova plugin add cordova-plugin-whitelist
        cordova plugin add cordova-plugin-network-information
        
        echo "âœ… Plugins added"
    
    - name: ðŸ› ï¸ Build Android APK
      run: |
        cd cordova-build
        
        echo "ðŸ› ï¸ Building Android APK..."
        echo "This may take 2-3 minutes..."
        
        # Build debug APK
        cordova build android --debug
        
        echo "âœ… Build process completed"
    
    - name: ðŸ“Š Check Build Results
      run: |
        cd cordova-build
        
        echo "ðŸ“Š Checking build results..."
        
        APK_DIR="platforms/android/app/build/outputs/apk/debug"
        
        if [ -d "$APK_DIR" ]; then
          echo "APK directory contents:"
          ls -la "$APK_DIR/"
          
          APK_FILE=$(find "$APK_DIR" -name "*.apk" | head -1)
          if [ -n "$APK_FILE" ]; then
            echo ""
            echo "âœ… APK FOUND: $APK_FILE"
            echo "ðŸ“¦ Size: $(du -h "$APK_FILE" | cut -f1)"
          else
            echo "âŒ No APK files found in $APK_DIR"
          fi
        else
          echo "âŒ APK directory not found: $APK_DIR"
          echo "Available platforms directories:"
          find platforms/android -type d 2>/dev/null || echo "No platforms directory"
        fi
    
    - name: â¬†ï¸ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: DarkSystem-APK
        path: |
          cordova-build/platforms/android/app/build/outputs/apk/debug/*.apk
          cordova-build/platforms/android/app/build/outputs/apk/release/*.apk
        if-no-files-found: error
        retention-days: 7
    
    - name: ðŸ“¦ Package Backend Files
      run: |
        echo "ðŸ“¦ Packaging backend files..."
        
        # Create distribution package
        mkdir -p dist
        
        # Copy APK if exists
        if [ -f "cordova-build/platforms/android/app/build/outputs/apk/debug/app-debug.apk" ]; then
          cp cordova-build/platforms/android/app/build/outputs/apk/debug/app-debug.apk dist/DarkSystem-v3.0.apk
        fi
        
        # Copy backend files
        if [ -d "backend" ]; then
          cp -r backend dist/
        fi
        
        # Create README
        cat > dist/README.txt << 'EOF'
=====================================
DARK SYSTEM v3.0 - COMPLETE PACKAGE
=====================================

Contents:
1. DarkSystem-v3.0.apk - Android application
2. backend/ - Flask backend server

INSTALLATION:
1. Install APK on Android (enable Unknown Sources)
2. Run backend: python3 backend/app.py
3. Open app and login: IENZ / 1122

FEATURES:
- DDoS Attack Tools
- OSINT Gathering  
- WhatsApp Exploits
- Network Scanner

GitHub: https://github.com/ProScripter123/DarkSistem
EOF
        
        # Create zip
        zip -r DarkSystem-Complete-$(date +%Y%m%d).zip dist/
        
        echo "âœ… Distribution package created"
    
    - name: â¬†ï¸ Upload Complete Package
      uses: actions/upload-artifact@v4
      with:
        name: DarkSystem-Complete
        path: DarkSystem-Complete-*.zip
        retention-days: 7
    
    - name: ðŸ“ Generate Build Report
      if: always()
      run: |
        echo "## ðŸ—ï¸ Dark System Build Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** [ProScripter123/DarkSistem](https://github.com/ProScripter123/DarkSistem)" >> $GITHUB_STEP_SUMMARY
        echo "**Build Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if APK was created
        if [ -f "cordova-build/platforms/android/app/build/outputs/apk/debug/app-debug.apk" ]; then
          APK_SIZE=$(du -h cordova-build/platforms/android/app/build/outputs/apk/debug/app-debug.apk | cut -f1)
          
          echo "### âœ… BUILD SUCCESSFUL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated Files:**" >> $GITHUB_STEP_SUMMARY
          echo "- **DarkSystem-APK**: Contains the APK file ($APK_SIZE)" >> $GITHUB_STEP_SUMMARY
          echo "- **DarkSystem-Complete**: Complete package with backend" >> $GITHUB_STEP_SUMMARY
          
        else
          echo "### âš ï¸ BUILD COMPLETED WITH WARNINGS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "APK file may not have been generated correctly." >> $GITHUB_STEP_SUMMARY
          echo "Check artifacts for available files." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Login Credentials:" >> $GITHUB_STEP_SUMMARY
        echo "- **Username:** IENZ" >> $GITHUB_STEP_SUMMARY
        echo "- **Password:** 1122" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Installation:" >> $GITHUB_STEP_SUMMARY
        echo "1. Download from **Artifacts** section" >> $GITHUB_STEP_SUMMARY
        echo "2. Enable **Unknown Sources** on Android" >> $GITHUB_STEP_SUMMARY
        echo "3. Install APK" >> $GITHUB_STEP_SUMMARY
        echo "4. Open **Dark System** app" >> $GITHUB_STEP_SUMMARY
