name: Build HTML to APK (Cordova Debug)

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java 17 (untuk Gradle 9+)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Cordova
        run: npm install -g cordova@11.0.0

      - name: Install project dependencies
        run: npm install

      - name: Clean and add Android platform
        run: |
          rm -rf platforms android plugins
          cordova platform add android@11.0.0 --verbose

      - name: Force Gradle 7.x for Cordova compatibility
        run: |
          # Update gradle wrapper to version 7.x
          cd platforms/android
          ./gradlew wrapper --gradle-version=7.6 --distribution-type=bin
          
          # Update gradle distribution URL in gradle-wrapper.properties
          sed -i 's|distributionUrl=.*|distributionUrl=https\://services.gradle.org/distributions/gradle-7.6-bin.zip|' gradle/wrapper/gradle-wrapper.properties
          
          # Set Java compatibility in build.gradle
          if [ -f "app/build.gradle" ]; then
            sed -i '/android {/a\    compileOptions {\n        sourceCompatibility JavaVersion.VERSION_11\n        targetCompatibility JavaVersion.VERSION_11\n    }' app/build.gradle
          fi
          
          cd ../..

      - name: Set Gradle properties for compatibility
        run: |
          cat > platforms/android/gradle.properties << 'EOF'
org.gradle.jvmargs=-Xmx4096m
android.useAndroidX=true
android.enableJetifier=true
EOF

      - name: Verify Java and Gradle versions
        run: |
          echo "=== Java Version ==="
          java -version
          echo "=== Gradle Wrapper Version ==="
          cd platforms/android && ./gradlew --version && cd ../..

      - name: Build Android APK
        run: |
          cordova build android --debug --verbose 2>&1 | tee build.log || {
            echo "=== Build failed, showing error ==="
            tail -50 build.log
            exit 1
          }

      - name: Find and upload APK
        run: |
          echo "=== Finding APK files ==="
          find platforms/android -name "*.apk" -type f
          
          # Copy APK to predictable location
          mkdir -p dist
          find platforms/android -name "*debug*.apk" -type f -exec cp {} dist/ \;
          
          echo "=== APKs in dist/ ==="
          ls -la dist/

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: dist/*.apk
          if-no-files-found: error

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build.log
