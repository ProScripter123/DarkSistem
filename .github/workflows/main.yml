name: Build Dark System APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger option

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ Checkout repository
      uses: actions/checkout@v4
    
    - name: â˜• Setup Java JDK 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: ðŸ“± Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        licenses: |
          8933bad161af4178b1185d1a37fbf41ea5269c55
          d56f5187479451eabf01fb78af6dfcb131a6481e
          24333f8a63b6825ea9c5514f83c2829b004d1fee
    
    - name: ðŸ”§ Install Android SDK components
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"
    
    - name: âš¡ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ðŸ“¦ Install Cordova globally
      run: npm install -g cordova@latest
    
    - name: ðŸ” Check Cordova version
      run: cordova --version
    
    - name: ðŸ—ï¸ Create Cordova project structure
      run: |
        # Create fresh Cordova project
        cordova create darksystem-build com.darksystem.app "DarkSystem"
        cd darksystem-build
        
        # Add Android platform
        cordova platform add android@12.0.0
        
        # Remove default www content
        rm -rf www/*
        
        echo "âœ… Cordova project created"
    
    - name: ðŸ“ Copy Dark System files
      run: |
        cd darksystem-build
        
        # Check if source files exist
        if [ -d "../www" ]; then
          echo "ðŸ“‚ Copying www directory..."
          cp -r ../www/* www/
        else
          echo "âš ï¸ www directory not found, creating minimal structure"
          mkdir -p www
          # Create minimal HTML file
          cat > www/index.html << 'HTML'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Dark System</title>
              <style>
                  body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
                  h1 { color: #0f0; }
                  .login { background: #111; padding: 20px; margin: 20px 0; }
                  input, button { padding: 10px; margin: 5px; }
              </style>
          </head>
          <body>
              <h1>ðŸ”§ Dark System v3.0</h1>
              <div class="login">
                  <h3>Login:</h3>
                  <input type="text" placeholder="Username" value="IENZ"><br>
                  <input type="password" placeholder="Password" value="1122"><br>
                  <button>Login</button>
              </div>
              <p>APK built via GitHub Actions</p>
          </body>
          </html>
          HTML
        fi
        
        # Ensure icon directory exists
        mkdir -p www/res/icon/android
        if [ ! -f "www/res/icon/android/darksystem.jpg" ]; then
          echo "ðŸ–¼ï¸ Creating placeholder icon..."
          echo "Dark System Icon" > www/res/icon/android/darksystem.jpg
        fi
        
        echo "âœ… Files copied"
    
    - name: âš™ï¸ Create config.xml
      run: |
        cd darksystem-build
        
        cat > config.xml << 'XML'
        <?xml version='1.0' encoding='utf-8'?>
        <widget id="com.darksystem.app" version="3.0.0" xmlns="http://www.w3.org/ns/widgets">
            <name>Dark System</name>
            <description>Penetration Testing Toolkit</description>
            <author>Dark Team</author>
            
            <content src="index.html" />
            
            <!-- Allow all network access -->
            <access origin="*" />
            <allow-intent href="http://*/*" />
            <allow-intent href="https://*/*" />
            
            <!-- Preferences -->
            <preference name="android-minSdkVersion" value="21" />
            <preference name="android-targetSdkVersion" value="33" />
            <preference name="Orientation" value="portrait" />
            <preference name="Fullscreen" value="false" />
            
            <!-- Android platform config -->
            <platform name="android">
                <!-- Simple icon config -->
                <icon src="www/res/icon/android/darksystem.jpg" />
                
                <!-- Permissions -->
                <config-file parent="/manifest" target="AndroidManifest.xml">
                    <uses-permission android:name="android.permission.INTERNET" />
                    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
                    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
                    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="28" />
                    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
                    <uses-permission android:name="android.permission.WAKE_LOCK" />
                </config-file>
            </platform>
        </widget>
        XML
        
        echo "âœ… config.xml created"
    
    - name: ðŸ”Œ Add Cordova plugins
      run: |
        cd darksystem-build
        
        # Add essential plugins
        cordova plugin add cordova-plugin-whitelist
        cordova plugin add cordova-plugin-network-information
        cordova plugin add cordova-plugin-file
        
        echo "âœ… Plugins installed"
    
    - name: ðŸ› ï¸ Build Debug APK
      run: |
        cd darksystem-build
        
        echo "ðŸš€ Building Debug APK..."
        cordova build android --debug --verbose
        
        echo "âœ… Build completed"
    
    - name: ðŸ“Š List APK files
      run: |
        cd darksystem-build
        
        echo "ðŸ“ APK Output Directory:"
        find platforms/android/app/build/outputs/apk -name "*.apk" -type f | xargs ls -la
        
        echo ""
        echo "ðŸ“¦ APK Files Found:"
        find platforms/android/app/build/outputs/apk -name "*.apk" | while read file; do
          echo "  - $file ($(du -h "$file" | cut -f1))"
        done
    
    - name: â¬†ï¸ Upload Debug APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: DarkSystem-Debug-APK
        path: |
          darksystem-build/platforms/android/app/build/outputs/apk/debug/*.apk
        retention-days: 7
    
    - name: ðŸ·ï¸ Create Release APK (Optional)
      run: |
        cd darksystem-build
        
        echo "ðŸ” Building Release APK (unsigned)..."
        cordova build android --release --verbose 2>&1 | tail -50 || echo "Release build may need keystore"
        
        # List release APKs if any
        if ls platforms/android/app/build/outputs/apk/release/*.apk 1> /dev/null 2>&1; then
          echo "ðŸ“¦ Release APKs found:"
          ls -la platforms/android/app/build/outputs/apk/release/*.apk
        fi
      continue-on-error: true
    
    - name: â¬†ï¸ Upload Release APK artifact (if exists)
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: DarkSystem-Release-APK
        path: |
          darksystem-build/platforms/android/app/build/outputs/apk/release/*.apk
        retention-days: 7
    
    - name: ðŸ“ Generate build summary
      if: always()
      run: |
        echo "## ðŸ—ï¸ Dark System Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± APK Files Generated:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "darksystem-build/platforms/android/app/build/outputs/apk/debug/app-debug.apk" ]; then
          APK_SIZE=$(du -h darksystem-build/platforms/android/app/build/outputs/apk/debug/app-debug.apk | cut -f1)
          echo "- âœ… **Debug APK**: app-debug.apk ($APK_SIZE)" >> $GITHUB_STEP_SUMMARY
          echo "  - Download from Artifacts tab" >> $GITHUB_STEP_SUMMARY
          echo "  - Username: IENZ" >> $GITHUB_STEP_SUMMARY
          echo "  - Password: 1122" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Debug APK not found" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Installation Instructions:" >> $GITHUB_STEP_SUMMARY
        echo "1. Download APK from Artifacts tab" >> $GITHUB_STEP_SUMMARY
        echo "2. Transfer to Android device" >> $GITHUB_STEP_SUMMARY
        echo "3. Enable **Unknown Sources** in Settings â†’ Security" >> $GITHUB_STEP_SUMMARY
        echo "4. Install APK" >> $GITHUB_STEP_SUMMARY
        echo "5. Open app and login with IENZ / 1122" >> $GITHUB_STEP_SUMMARY
